<!-- Modal de senha -->
<div class="password-modal" id="password-modal">
    <div class="password-box">
        <h2>üîê Biblioteca T√©cnica</h2>
        <p>Digite a senha para acessar o conte√∫do</p>
        <input type="password" id="password-input" placeholder="Senha" autofocus>
        <button id="unlock-btn">Acessar</button>
        <div class="error" id="password-error">Senha incorreta. Tente novamente.</div>
    </div>
</div>

<div class="container">
    <nav class="breadcrumb">
        <a href="{{baseUrl}}/">In√≠cio</a> > 
        <span>Biblioteca</span>
    </nav>

    <header class="page-header">
        <h1>üìö Biblioteca T√©cnica</h1>
        <p>Cole√ß√£o curada de {{totalBooks}} livros t√©cnicos essenciais</p>
    </header>

    <!-- Filters -->
    <div class="library-filters">
        <div class="filters-grid">
            <div class="filter-group">
                <label for="search">üîç Buscar</label>
                <input type="text" id="search" placeholder="T√≠tulo, autor...">
            </div>

            <div class="filter-group">
                <label for="category">üìÇ Categoria</label>
                <select id="category">
                    <option value="">Todas</option>
                    {{#categories}}
                    <option value="{{.}}">{{.}}</option>
                    {{/categories}}
                </select>
            </div>

            <div class="filter-group">
                <label for="format">üìÑ Formato</label>
                <select id="format">
                    <option value="">Todos</option>
                    <option value="pdf">PDF</option>
                    <option value="epub">EPUB</option>
                </select>
            </div>
        </div>

        <div class="stats">
            <span id="visible-count">{{totalBooks}}</span> de <span id="total-count">{{totalBooks}}</span> livros
        </div>
    </div>

    <!-- Books Grid -->
    <div class="books-grid" id="books-grid">
        <!-- Books will be loaded here via JavaScript -->
    </div>
</div>

<!-- Library-specific styles -->
<style>
    /* Modal de senha */
    .password-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
    }

    .password-modal.hidden {
        display: none;
    }

    .password-box {
        background: var(--bg-primary, white);
        padding: 2.5rem;
        border-radius: 8px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        max-width: 400px;
        width: 90%;
    }

    .password-box h2 {
        color: var(--primary-green, #2d5a27);
        margin-bottom: 1rem;
        font-size: 1.5rem;
    }

    .password-box p {
        color: var(--text-secondary, #6c757d);
        margin-bottom: 1.5rem;
    }

    .password-box input {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid var(--border-color, #dee2e6);
        border-radius: 4px;
        font-size: 1rem;
        margin-bottom: 1rem;
        background: var(--bg-primary, white);
        color: var(--text-primary, #1a1a1a);
    }

    .password-box input:focus {
        outline: none;
        border-color: var(--primary-green, #2d5a27);
    }

    .password-box button {
        width: 100%;
        padding: 0.75rem;
        background: var(--primary-green, #2d5a27);
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 1rem;
        cursor: pointer;
        font-weight: 600;
    }

    .password-box button:hover {
        background: var(--primary-green-dark, #1e3d1a);
    }

    .password-box button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .password-box .error {
        color: #dc3545;
        font-size: 0.9rem;
        margin-top: 0.5rem;
        display: none;
    }

    .password-box .error.show {
        display: block;
    }

    /* Library Filters */
    .library-filters {
        background-color: var(--bg-secondary, #f8f9fa);
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        border: 1px solid var(--border-color, #dee2e6);
    }

    .filters-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .filter-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: var(--text-primary, #1a1a1a);
        font-size: 0.9rem;
    }

    .filter-group select,
    .filter-group input {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid var(--border-color, #dee2e6);
        border-radius: 4px;
        font-size: 0.95rem;
        background-color: var(--bg-primary, white);
        color: var(--text-primary, #1a1a1a);
    }

    .filter-group select:focus,
    .filter-group input:focus {
        outline: none;
        border-color: var(--primary-green, #2d5a27);
    }

    .stats {
        text-align: center;
        color: var(--text-secondary, #6c757d);
        font-size: 0.95rem;
    }

    /* Books Grid */
    .books-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.5rem;
        padding: 2rem 0;
    }

    .book-card {
        background: var(--bg-primary, white);
        border: 1px solid var(--border-color, #dee2e6);
        border-radius: 8px;
        overflow: hidden;
        transition: transform 0.2s, box-shadow 0.2s;
        display: flex;
        flex-direction: column;
    }

    .book-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .book-cover {
        width: 100%;
        height: 300px;
        background-color: var(--bg-secondary, #f8f9fa);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
    }

    .book-cover img {
        max-width: 100%;
        max-height: 100%;
        width: auto;
        height: auto;
        object-fit: contain;
    }

    .book-info {
        padding: 1rem;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }

    .book-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: var(--text-primary, #1a1a1a);
        line-height: 1.3;
    }

    .book-author {
        font-size: 0.9rem;
        color: var(--text-secondary, #6c757d);
        margin-bottom: 0.5rem;
    }

    .book-meta {
        font-size: 0.85rem;
        color: var(--text-secondary, #6c757d);
        margin-bottom: 0.75rem;
    }

    .book-category {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        background-color: var(--bg-secondary, #f8f9fa);
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--primary-green, #2d5a27);
        margin-bottom: 0.75rem;
    }

    .book-description {
        font-size: 0.9rem;
        line-height: 1.6;
        color: var(--text-secondary, #6c757d);
        margin-bottom: 0.75rem;
        overflow: hidden;
        transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .book-description.collapsed {
        max-height: 0;
        margin-bottom: 0;
    }

    .book-description.expanded {
        max-height: 300px;
        transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .description-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.5rem;
        background: transparent;
        border: 1px solid var(--border-color, #dee2e6);
        border-radius: 4px;
        font-size: 0.85rem;
        color: var(--text-secondary, #6c757d);
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: 0.75rem;
        width: 100%;
        font-weight: 500;
    }

    .description-toggle:hover {
        background-color: var(--bg-secondary, #f8f9fa);
        border-color: var(--primary-green, #2d5a27);
        color: var(--primary-green, #2d5a27);
    }

    .description-toggle .icon {
        transition: transform 0.3s;
        font-size: 0.9rem;
    }

    .description-toggle.expanded .icon {
        transform: rotate(180deg);
    }

    .book-formats {
        display: flex;
        gap: 0.5rem;
        margin-top: auto;
    }

    .format-link {
        flex: 1;
        padding: 0.5rem;
        background-color: var(--primary-green, #2d5a27);
        color: white;
        text-align: center;
        text-decoration: none;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 600;
        transition: background-color 0.2s;
    }

    .format-link:hover {
        background-color: var(--primary-green-dark, #1e3d1a);
    }

    .book-card.hidden {
        display: none;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .filters-grid {
            grid-template-columns: 1fr;
        }

        .books-grid {
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        }
    }
</style>

<!-- CryptoJS for decryption -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script>
    // Global variables
    let allBooks = [];
    const searchInput = document.getElementById('search');
    const categorySelect = document.getElementById('category');
    const formatSelect = document.getElementById('format');
    const booksGrid = document.getElementById('books-grid');
    const visibleCount = document.getElementById('visible-count');
    const modal = document.getElementById('password-modal');
    const passwordInput = document.getElementById('password-input');
    const unlockBtn = document.getElementById('unlock-btn');
    const errorMsg = document.getElementById('password-error');

    function decryptData(encryptedData, password) {
        try {
            const decrypted = CryptoJS.AES.decrypt(encryptedData, password);
            const decryptedText = decrypted.toString(CryptoJS.enc.Utf8);
            
            if (!decryptedText) {
                return null;
            }
            
            return JSON.parse(decryptedText);
        } catch (error) {
            console.error('Decryption error:', error);
            return null;
        }
    }

    // Load and decrypt books
    async function loadBooks(password) {
        try {
            const response = await fetch('books-data.enc');
            const encryptedData = await response.text();
            
            const data = decryptData(encryptedData, password);
            
            if (!data) {
                return false;
            }
            
            allBooks = data.books;
            renderBooks(allBooks);
            modal.classList.add('hidden');
            return true;
        } catch (error) {
            console.error('Error loading books:', error);
            return false;
        }
    }

    // Render books
    function renderBooks(books) {
        booksGrid.innerHTML = books.map(book => `
            <article class="book-card" data-category="${book.category}" data-formats="${Object.keys(book.formats || {}).join(' ')}" data-search="${book.title} ${book.author} ${book.category}">
                <div class="book-cover">
                    <img src="${book.cover}" alt="Capa do livro ${book.title}" loading="lazy" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22280%22%3E%3Crect fill=%22%23f8f9fa%22 width=%22200%22 height=%22280%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-family=%22Arial%22 font-size=%2216%22 fill=%22%236c757d%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22%3Eüìñ%3C/text%3E%3C/svg%3E'">
                </div>
                <div class="book-info">
                    <h2 class="book-title">${book.title}</h2>
                    <div class="book-author">${book.author}</div>
                    <div class="book-meta">${book.publisher} ‚Ä¢ ${book.year}</div>
                    <div class="book-category">${book.category}</div>
                    ${book.description ? `
                        <button class="description-toggle" onclick="toggleDescription(this)" aria-label="Mostrar descri√ß√£o">
                            <span>Sobre o livro</span>
                            <span class="icon">‚ñº</span>
                        </button>
                        <div class="book-description collapsed">
                            ${book.description}
                        </div>
                    ` : ''}
                    <div class="book-formats">
                        ${book.formats.epub ? `<a href="${book.formats.epub}" class="format-link" target="_blank" rel="noopener noreferrer">üìï EPUB</a>` : ''}
                        ${book.formats.pdf ? `<a href="${book.formats.pdf}" class="format-link" target="_blank" rel="noopener noreferrer">üìÑ PDF</a>` : ''}
                    </div>
                </div>
            </article>
        `).join('');
        
        visibleCount.textContent = books.length;
    }

    // Toggle description
    function toggleDescription(button) {
        const description = button.nextElementSibling;
        const isExpanded = !description.classList.contains('collapsed');
        
        if (isExpanded) {
            description.classList.add('collapsed');
            description.classList.remove('expanded');
            button.classList.remove('expanded');
            button.setAttribute('aria-label', 'Mostrar descri√ß√£o');
            button.querySelector('span:first-child').textContent = 'Sobre o livro';
        } else {
            description.classList.remove('collapsed');
            description.classList.add('expanded');
            button.classList.add('expanded');
            button.setAttribute('aria-label', 'Ocultar descri√ß√£o');
            button.querySelector('span:first-child').textContent = 'Ocultar';
        }
    }

    // Filter books
    function filterBooks() {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedCategory = categorySelect.value;
        const selectedFormat = formatSelect.value;
        
        const bookCards = Array.from(document.querySelectorAll('.book-card'));
        let visibleBooks = 0;
        
        bookCards.forEach(card => {
            const searchText = card.dataset.search.toLowerCase();
            const category = card.dataset.category;
            const formats = card.dataset.formats;
            
            const matchesSearch = searchText.includes(searchTerm);
            const matchesCategory = !selectedCategory || category === selectedCategory;
            const matchesFormat = !selectedFormat || formats.includes(selectedFormat);
            
            if (matchesSearch && matchesCategory && matchesFormat) {
                card.classList.remove('hidden');
                visibleBooks++;
            } else {
                card.classList.add('hidden');
            }
        });
        
        visibleCount.textContent = visibleBooks;
        booksGrid.style.display = visibleBooks === 0 ? 'none' : 'grid';
    }

    // Event listeners
    unlockBtn.addEventListener('click', async () => {
        const password = passwordInput.value;
        if (!password) return;
        
        unlockBtn.disabled = true;
        unlockBtn.textContent = 'Verificando...';
        
        const success = await loadBooks(password);
        
        if (success) {
            errorMsg.classList.remove('show');
        } else {
            errorMsg.classList.add('show');
            unlockBtn.disabled = false;
            unlockBtn.textContent = 'Acessar';
            passwordInput.value = '';
            passwordInput.focus();
        }
    });

    passwordInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            unlockBtn.click();
        }
    });

    searchInput.addEventListener('input', () => {
        clearTimeout(window.searchTimeout);
        window.searchTimeout = setTimeout(filterBooks, 300);
    });
    
    categorySelect.addEventListener('change', filterBooks);
    formatSelect.addEventListener('change', filterBooks);

    // Focus password input
    passwordInput.focus();
</script>
